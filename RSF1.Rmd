---
title: "RSF"
output: html_document
date: "2023-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}

### Prepare the work space
library(tidyverse)
library(dplyr)
library(scales)
library(beepr)
library(lubridate)
library(ResourceSelection)
library(RColorBrewer)
library(cowplot)
library(colorBlindness)
library(kableExtra)
library(lme4)
library(stats)
library(DHARMa)
library(lattice)
library(broom)
library(modelsummary)
library(kableExtra)
library(gt)
library(readxl)
library(xlsx)
library(corrplot)
library(vegan)

getwd()
# "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/Documents/1. PhD_Main/GitHub_link/Nittedal/SpatialAndMorphology_MBRA_MMYS"

output <- "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/1. Nittedal 2018-2020/Nittedal_Main/Analyses/Outputs"

file.name <- "RSF"

todays_date <- Sys.Date()
 
dir.name <- str_c(output,"/", file.name, "_", todays_date)
dir.name
 
output_today <- dir.name
output_today

dir.create(output_today)
output_today


```


```{r}

## Covariates from LiDAR data prepared by Hans Ole 
vars <- readRDS("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/1. Nittedal 2018-2020/Nittedal_Main/Analyses/Inputs/SpatialData/vars_dist45_v3.rds")

#Used and available positions - just for referencing. 
# rsf.data <- read_csv("C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/1. Nittedal 2018-2020/Nittedal_Main/Analyses/Outputs/HomeRangeExploration_2023-09-28/used_available_pts_combined95KE.csv", 
#      col_types = cols(...1 = col_skip()))

summary(vars)
str(vars) # sf data frame
# 16522 observations of 47 variables 

names(vars)
# [1] "BatID"             "Easting"           "Northing"          "used"              "Species"          
#  [6] "UTM"               "Hmax"              "Hmean"             "Hsd"               "Hcv"              
# [11] "Hkurt"             "Hskewness"         "H10"               "H20"               "H30"              
# [16] "H40"               "H50"               "H60"               "H70"               "H80"              
# [21] "H90"               "H95"               "D0"                "D1"                "D2"               
# [26] "D3"                "D4"                "D5"                "D6"                "D7"               
# [31] "D8"                "D9"                "gap3.n"            "gap3.mean.area"    "gap3.sd.area"     
# [36] "gap3.sum.area"     "gap5.n"            "gap5.mean.area"    "gap5.sd.area"      "gap5.sum.area"    
# [41] "ttops.n"           "crown.mean.size"   "crown.sd.size"     "ttops.mean.height" "ttops.sd.height"  
# [46] "water.distance"    "water.objtype"     "YOD"               "DIST"              "geom"           

## For writing descriptions of each variable 

#mettext <- as.data.frame(names(vars))
# write.csv(mettext, "~mettext.csv") # 15.11.2023
```

# Housekeeping of LiDAR data 

```{r}
str(vars)
summary(vars)


# Hans Ole: HOW TO DEAL WITH NAs:
dt <- vars
summary(dt[is.na(dt$Hmean),])
dt$H10[is.na(dt$Hmax)] <- 0.5
dt$Hmean[is.na(dt$Hmean)] <- 0.5
dt$H10[is.na(dt$H10)] <- 0.5
dt$H20[is.na(dt$H20)] <- 0.5
dt$H30[is.na(dt$H30)] <- 0.5
dt$H40[is.na(dt$H40)] <- 0.5
dt$H50[is.na(dt$H50)] <- 0.5
dt$H60[is.na(dt$H60)] <- 0.5
dt$H70[is.na(dt$H70)] <- 0.5
dt$H80[is.na(dt$H80)] <- 0.5
dt$H90[is.na(dt$H90)] <- 0.5
dt$H95[is.na(dt$H95)] <- 0.5
set.seed(123)
un <- runif(10000)

dt$Hsd[is.na(dt$Hsd)] <- sd(un)
dt$Hcv[is.na(dt$Hcv)] <- dt$Hsd[is.na(dt$Hcv)] / dt$Hmean[is.na(dt$Hcv)]
dt$crown.mean.size[is.na(dt$crown.mean.size)] <- 0
dt$ttops.mean.height[is.na(dt$ttops.mean.height)] <- 0

dt$gap5.sd.area[is.na(dt$gap5.sd.area)] <- 0
dt$gap3.sd.area[is.na(dt$gap3.sd.area)] <- 0
dt$crown.sd.size[is.na(dt$crown.sd.size)] <- 0
dt$ttops.sd.height[is.na(dt$ttops.sd.height)] <- 0
summary(dt)

# Hmax -Inf = 0.5
dt$Hmax[dt$Hmax == "-Inf"] <- 0.5

## NAs for Hkurt and Hskewness: 
#  Generate a uniform distribution between 0 and 1 and compute the value of that

# Hkurt NA = -1.183527 
dt$Hkurt[is.na(dt$Hkurt)] <- -1.183527 

# Hskewness NA = 0.004507174 
dt$Hskewness[is.na(dt$Hskewness)] <- -0.004507174 


dt$Species=as.factor(dt$Species)
dt$BatID=as.factor(dt$BatID)
dt$water.objtype=as.factor(dt$water.objtype)

dt$YOD[is.na(dt$YOD)] <- "Undetected"
dt$YOD=as.factor(dt$YOD)


### Check for suspicious outliers
summary(dt)

# 16522 obs of 23 vars 
# There is an Hmax value of 99.77 m with the next highest value being ~30 m. This is some sort of miscalculation in the canopy height model, so it will be removed. (Available (used = 0) point for Astrid (MBRA)). 

## First convert to a normal dataframe(drop geoms/sf objects) 
dt1df <- as.data.frame(dt)
dt1df <- dt1df %>% select(-geom)
# 16484 obs of 49 vars



dt2df <- dt1df %>% dplyr::filter(Hmax < 90)
# 16483 obs of 49 vars

summary(dt2df)

## Are there any strong outliers amongst n of local maxima? 
hist(dt2df$ttops.n) 
# How does this look for used points? 
dt2dfused <- dt2df %>% filter(used == 1)
hist(dt2dfused$ttops.n) 
# what proportion of the dataset has a ttops.n value of less than 5? 
 
openareas <- dt2df %>% filter(ttops.n <= 5)
# 2377 obs 
2377/16483
# 14%
# How many of these open area observations are actual used points? 

summary(openareas)
table(openareas$used) # 17 points 
 
openused <- openareas %>% filter(used == 1 ) %>%  droplevels()

summary(openused)
table(openused$Species)
  # M.brandtii M.mystacinus 
  #          8            9 
table(openused$BatID)
# Amelia  Dagny  Ethel Louise Phoebe  Reeda Steffi  Stine   Thea 
#      2      1      2      2      5      1      1      2      1 



### Think of a way to more distinctly categorize "open areas". 


#### Scale continuous variables for ordination and modelling
dt1 <- dt2df # Use this to scale all continuous numerical data 
dt1[,7:46]=scale(dt1[,7:46], scale=TRUE) #
#
# names(dt1)


```


## Correlation/collinearity between LiDAR variables 
```{r}
# names(dt1)
# dtc <- dt1 %>% dplyr::select(c(
#   Hmax, Hmean, Hsd, Hcv, Hskewness, 
#   H10, H20, H30, H40,  H50, H60, H70, H80, H90, H95, 
#   D0, D1, D2, D3, D4, D5, D6, D7, D8, D9, 
#   gap3.n, gap3.mean.area,  gap3.sd.area,  gap3.sum.area,  
#   gap5.n, gap5.mean.area,  gap5.sd.area,  gap5.sum.area,  
#   ttops.n, ttops.mean.height, ttops.sd.height)) 
# 
# windows()
# 
# corrplot(cor(dtc))
```



# NMDS ordination of available points to address collinearity and discern patterns in how variables influence each other 


### Prepare data for PCA 
```{r}

## Create an ID column so the bat meta data can be reattached later

## Create a unique row id which will become "idvar"

dt1$idvar <- paste0("ID-", 1:nrow(dt1)) 
headings <- dt1$idvar

## Now only includeLiDAR variables with IDvar
names(dt1)

dt2 <- dt1 %>% dplyr::select(c(
  Hmax, Hmean, Hsd, Hcv, Hskewness, Hkurt, 
  H10, H20, H30, H40,  H50, H60, H70, H80, H90, H95, 
  D0, D1, D2, D3, D4, D5, D6, D7, D8, D9, 
  gap3.n, gap3.mean.area,  gap3.sd.area,  gap3.sum.area,  
  gap5.n, gap5.mean.area,  gap5.sd.area,  gap5.sum.area,  
  ttops.n, ttops.mean.height, ttops.sd.height)) 
## Remove hskewness for now because it has negative values... 
rownames(dt2) <- headings
# Reshape into wide format 

summary(dt2)
## This is a PCA, more info below: 

mat <- dt2 

### In case you want to do a PCA for only used points later 
# mat.used <- dt1 %>%
#   dplyr::filter(used == 1) %>% 
#   droplevels() %>% 
#   dplyr::select(c(
#   Hmax, Hmean, Hsd, Hcv, Hskewness, 
#   H10, H20, H30, H40,  H50, H60, H70, H80, H90, H95, 
#   D0, D1, D2, D3, D4, D5, D6, D7, D8, D9, 
#   gap3.n, gap3.mean.area,  gap3.sd.area,  gap3.sum.area,  
#   gap5.n, gap5.mean.area,  gap5.sd.area,  gap5.sum.area,  
#   ttops.n, ttops.mean.height, ttops.sd.height)) 

```


## PCA
```{r}
## PCA 
trait.pca <- rda(mat) # used and available points together 

biplot(trait.pca) # simple plot 
screeplot(trait.pca) # how much of each axis describes the variation in the data 

summary(trait.pca)

pca.summary <- summary(trait.pca)

trait.loadings <- as.data.frame(pca.summary$species) %>% 
  mutate(trait = rownames(.))  
head(trait.loadings)



meta <- dt1 %>% dplyr::select(c(used, Species, idvar)) 
# for now, do not include bat.id

## Build meta data to be reattached in plotting
rownames(meta) <- meta$idvar
meta$gen.spe <- meta$idvar
meta$used <- as.factor(meta$used)

sp.scores <- as.data.frame(pca.summary$sites) %>% 
  mutate(gen.spe = rownames(.)) %>% inner_join(meta) 
# now used data is there

traittable <- trait.loadings  %>% 
  dplyr::select(trait, PC1, PC2)
#write.csv(traittable, file = file.path(output_today, "bothbats_allpts_PCA1_2_table.csv")) # 26.11.2023


spdf <- left_join(sp.scores, dt1, by = "idvar")
spdf1 <- spdf %>% dplyr::select(-c(PC3, PC4, PC5, PC6, idvar, gen.spe, used.x, used.y, Species.x, Species.y, BatID, Easting, Northing, UTM, YOD, DIST, water.distance, water.objtype))


#corrplot(cor(dtc))
cortab <- as.data.frame(cor(spdf1)) 

windows()
corrplot(cor(spdf1),
         tl.col="black", tl.srt=45,  
         type="lower", col=brewer.pal(n=5, name="Greys"))

cortab1 <- cortab[1:2,]
cortab2 <- t(cortab1)

#write.csv(cortab2, file = file.path(output_today, "cortab2.csv"))
# 28.11.2023

################################################################################
##### plotting 
################################################################################

## PC1 and PC2
pca.ggplot <- ggplot(data = sp.scores, aes(x = PC1, y = PC2)) +
  geom_point() +
  geom_segment(data = trait.loadings, 
               aes(x = 0, xend = PC1/2, y = 0, yend = PC2/2), lwd = 0.1) + # this is a new geom that allows you to draw segments like the ones for the loadings above
  geom_text(data = trait.loadings, aes(x = PC1/2, y = PC2/2+0.1, label = trait), size = 3) + # this adds text to the labels
  theme_bw() 
pca.ggplot

## PC1 and PC3
pca.ggplot <- ggplot(data = sp.scores, aes(x = PC1, y = PC3)) +
  geom_point() +
  geom_segment(data = trait.loadings, 
               aes(x = 0, xend = PC1/2, y = 0, yend = PC2/2), lwd = 0.1) + # this is a new geom that allows you to draw segments like the ones for the loadings above
  geom_text(data = trait.loadings, aes(x = PC1/2, y = PC2/2+0.1, label = trait), size = 3) + # this adds text to the labels
  theme_bw() 
pca.ggplot



#### More advanved plotting, with meta data 

cols <- c("0" = "gray", "1" = "red")
col2 <- c("MBRA" = "skyblue", "MMYS" = "darkblue")

## PC1 and PC2 - used is color 
pca.ggplot <- ggplot(data = sp.scores, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = used), alpha = 0.3) +
  scale_color_manual(values = cols)+ 
  geom_segment(data = trait.loadings, 
               aes(x = 0, xend = PC1/2, y = 0, yend = PC2/2), lwd = 0.1) +
  geom_text(data = trait.loadings, aes(x = PC1/2, y = PC2/2+0.1, label = trait), size = 3) + 
  theme_bw() 
pca.ggplot

## PC1 and PC2 - used is color, separated by species 
pca.ggplot <- ggplot(data = sp.scores, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = used), alpha = 0.3) +
  scale_color_manual(values = cols)+ 
  geom_segment(data = trait.loadings, 
               aes(x = 0, xend = PC1/2, y = 0, yend = PC2/2), lwd = 0.1) +
  geom_text(data = trait.loadings, aes(x = PC1/2, y = PC2/2+0.1, label = trait), size = 3) + facet_wrap(~Species) +
  theme_bw() 
pca.ggplot

## PC1 and PC2 - used is color, separated by species AND used
pca.ggplot <- ggplot(data = sp.scores, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = used), alpha = 0.3) +
  scale_color_manual(values = cols)+ 
  geom_segment(data = trait.loadings, 
               aes(x = 0, xend = PC1/2, y = 0, yend = PC2/2), lwd = 0.1) +
  geom_text(data = trait.loadings, aes(x = PC1/2, y = PC2/2+0.1, label = trait), size = 3) + facet_wrap(used~Species) +
  theme_bw() 
pca.ggplot

```


# Model selection (explortatory approach)
We determined that the following covariates can be used to describe most of the variation in the LiDAR variables based on comparing the ordination of all LiDAR variables with PC1 and PC2, trait loadings and pearsons correlations coefficients between covariates and PC1:

H95
gap.sum.area (3 and 5)
gap.sd.area (3 and 5)
D0
Hsd

In addition we will include distance to water (dist.water) and bat ID as a random effect. 

I begin by modelling for each bat species separately with two candidate models - one with gap varaibles at 3 m and another with gap variables at 5 m. 

## RSF
```{r}

## Simple models - separated by bat species, no species interaction 
# install.packages("lme4", type = "source") 
# library(lme4)


MBRA <- dt1 %>% filter(Species == "M.brandtii") %>% droplevels() # 7633 obs of 49 vars
MMYS <- dt1 %>% filter(Species == "M.mystacinus") %>% droplevels() # 8850 obs of 49 vars

########################################################
########################  MBRA  ########################
########################################################

fit1MBRA= glmer(used ~  
                  gap3.mean.area + gap3.sd.area +
                  D0 + H95 + Hsd + water.distance +
                  (1|BatID), data=MBRA,
              family=binomial(link="logit"),nAGQ = 0) 

fit2MBRA= glmer(used ~  
                  gap5.mean.area + gap5.sd.area +
                  D0 + H95 + Hsd + water.distance +
                  (1|BatID), data=MBRA,
              family=binomial(link="logit"),nAGQ = 0) 
# boundary (singular) fit: see help('isSingular')

AIC(fit1MBRA, fit2MBRA)
#          df      AIC
# fit1MBRA  8 4367.075
# fit2MBRA  8 4330.863

########################################################
########################  MMYS  ########################
########################################################

fit1MMYS= glmer(used ~  
                  gap3.mean.area + gap3.sd.area +
                  D0 + H95 + Hsd + water.distance +
                  (1|BatID), data=MMYS,
              family=binomial(link="logit"),nAGQ = 0) 

fit2MMYS= glmer(used ~  
                  gap5.mean.area + gap5.sd.area +
                  D0 + H95 + Hsd + water.distance +
                  (1|BatID), data=MMYS,
              family=binomial(link="logit"),nAGQ = 0) 

AIC(fit1MMYS, fit2MMYS)
#          df      AIC
# fit1MMYS  8 5114.563
# fit2MMYS  8 5114.292

################################################
# The gap5 model for MBRA throws a singularity warning, and the AIC weights between the model pairs is very little so I will use the 3 m resolution models to continue. 

summary(fit1MBRA)
# Generalized linear mixed model fit by maximum likelihood (Adaptive
#   Gauss-Hermite Quadrature, nAGQ = 0) [glmerMod]
#  Family: binomial  ( logit )
# Formula: 
# used ~ gap3.mean.area + gap3.sd.area + D0 + H95 + Hsd + water.distance +  
#     (1 | BatID)
#    Data: MBRA
# 
#      AIC      BIC   logLik deviance df.resid 
#   4367.1   4422.6  -2175.5   4351.1     7625 
# 
# Scaled residuals: 
#     Min      1Q  Median      3Q     Max 
# -0.8595 -0.3602 -0.2616 -0.1916  6.3952 
# 
# Random effects:
#  Groups Name        Variance Std.Dev.
#  BatID  (Intercept) 0.003437 0.05863 
# Number of obs: 7633, groups:  BatID, 10
# 
# Fixed effects:
#                Estimate Std. Error z value Pr(>|z|)    
# (Intercept)    -2.41283    0.04967 -48.579  < 2e-16 ***
# gap3.mean.area -0.29348    0.06880  -4.265 2.00e-05 ***
# gap3.sd.area   -0.08817    0.04445  -1.984   0.0473 *  
# D0             -0.32482    0.06326  -5.135 2.83e-07 ***
# H95             0.74449    0.11199   6.648 2.97e-11 ***
# Hsd            -0.22818    0.10099  -2.259   0.0239 *  
# water.distance -0.44822    0.05015  -8.937  < 2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#             (Intr) gp3.m. gp3.s. D0     H95    Hsd   
# gap3.mean.r  0.012                                   
# gap3.sd.are -0.060  0.438                            
# D0           0.108  0.518  0.456                     
# H95         -0.161  0.300  0.119 -0.229              
# Hsd          0.044 -0.122 -0.136  0.232 -0.878       
# water.dstnc  0.189  0.255  0.207  0.005  0.019  0.051


summary(fit1MMYS)
# Generalized linear mixed model fit by maximum likelihood (Adaptive
#   Gauss-Hermite Quadrature, nAGQ = 0) [glmerMod]
#  Family: binomial  ( logit )
# Formula: 
# used ~ gap3.mean.area + gap3.sd.area + D0 + H95 + Hsd + water.distance +  
#     (1 | BatID)
#    Data: MMYS
# 
#      AIC      BIC   logLik deviance df.resid 
#   5114.6   5171.3  -2549.3   5098.6     8842 
# 
# Scaled residuals: 
#     Min      1Q  Median      3Q     Max 
# -0.9268 -0.3587 -0.2780 -0.1950  9.3631 
# 
# Random effects:
#  Groups Name        Variance Std.Dev.
#  BatID  (Intercept) 0.02742  0.1656  
# Number of obs: 8850, groups:  BatID, 11
# 
# Fixed effects:
#                Estimate Std. Error z value Pr(>|z|)    
# (Intercept)    -2.58026    0.07143 -36.124  < 2e-16 ***
# gap3.mean.area  0.18598    0.07071   2.630 0.008533 ** 
# gap3.sd.area    0.13158    0.04653   2.828 0.004686 ** 
# D0              0.26618    0.06871   3.874 0.000107 ***
# H95             0.66503    0.12364   5.379 7.49e-08 ***
# Hsd             0.03934    0.09400   0.419 0.675573    
# water.distance -0.48758    0.05212  -9.356  < 2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Correlation of Fixed Effects:
#             (Intr) gp3.m. gp3.s. D0     H95    Hsd   
# gap3.mean.r  0.036                                   
# gap3.sd.are  0.019  0.283                            
# D0          -0.020  0.426  0.445                     
# H95         -0.159  0.242 -0.009 -0.455              
# Hsd          0.031 -0.028 -0.047  0.450 -0.849       
# water.dstnc  0.231  0.141  0.074 -0.253  0.119 -0.065

library(sjPlot)
sjPlot::tab_model(fit1MBRA, fit1MMYS,fit2MBRA, fit2MMYS,
                  dv.labels = c(
                    "Myotis brandtii - 3 m", "Myotis mystacinus - 3 m",
                    "Myotis brandtii - 5 m", "Myotis mystacinus - 5 m"), transform = NULL, auto.label = FALSE) 

```

## Model diagnostics 
fit1MBRA
fit1MMYS

```{r}

### Diagnostics for fit1MBRA 
simulationOutput <- simulateResiduals(fittedModel = fit1MBRA, plot = T)
### Help with interpretation of residuals vs. predicted: 
# https://stats.stackexchange.com/questions/449208/diagnostic-plot-residual-vs-predicted-of-a-glmm-using-dharma
### recalculateResiduals()

# KS test -  the p-value shows you that there is *not* a significant deviation from the assumed distribution
# Dispersion test – Not over or underdispersed
# Outlier – No indication of outliers 
# 
# Residuals appear to more or less agree with predicted values 



windows()
testDispersion(simulationOutput)
# 
# 	DHARMa nonparametric dispersion test via sd of residuals fitted vs.
# 	simulated
# 
# data:  simulationOutput
# dispersion = 1.005, p-value = 0.888
# alternative hypothesis: two.sided



testZeroInflation(simulationOutput)
# 	DHARMa zero-inflation test via comparison to expected zeros with simulation
# 	under H0 = fitted model
# 
# data:  simulationOutput
# ratioObsSim = 0.99996, p-value = 0.992
# alternative hypothesis: two.sided

testQuantiles(simulationOutput)
# 	Test for location of quantiles via qgam
# 
# data:  simulationOutput
# p-value = 0.08098
# alternative hypothesis: both

testCategorical(simulationOutput, catPred = MBRA$BatID)
## No bat IDs had a low p value for the Asymptotic  one-sample Kolmogorov-Smirnov test

levels(MMYS$BatID)



##########################################################################

### Diagnostics for fit1MMYS 
simulationOutput <- simulateResiduals(fittedModel = fit1MMYS, plot = T)
### Help with interpretation of residuals vs. predicted: 
# https://stats.stackexchange.com/questions/449208/diagnostic-plot-residual-vs-predicted-of-a-glmm-using-dharma
### recalculateResiduals()

# KS test -  the p-value shows you that there is *not* a significant deviation from the assumed distribution
# Dispersion test – Not over or underdispersed
# Outlier – No indication of outliers 
# 
# Residuals appear to more or less agree with predicted values 



windows()
testDispersion(simulationOutput)
# 
# 	DHARMa nonparametric dispersion test via sd of residuals fitted vs.
# 	simulated
# 
# data:  simulationOutput
# dispersion = 1.005, p-value = 0.888
# alternative hypothesis: two.sided
# No evidence of dispersion 



testZeroInflation(simulationOutput)
# 	DHARMa zero-inflation test via comparison to expected zeros with simulation
# 	under H0 = fitted model
# 
# data:  simulationOutput
# ratioObsSim = 1.0025, p-value = 0.64
# alternative hypothesis: two.sided

testQuantiles(simulationOutput)
# 	Test for location of quantiles via qgam
# 
# data:  simulationOutput
# p-value = 0.0005186
# alternative hypothesis: both



testCategorical(simulationOutput, catPred = MMYS$BatID)
## No bat IDs had a low p value for the Asymptotic  one-sample Kolmogorov-Smirnov test

```


## Sketch model fit for model  to understand what the model is telling us 
```{r}
############################################################

##refitting model with GLM to sketch results

fit1mbra <- glm(used ~ gap3.mean.area + gap3.sd.area +
                  D0 + H95 + Hsd + water.distance,
                  family=binomial(), data=MBRA)

summary(fit1mbra)
# Call:
# glm(formula = used ~ gap3.mean.area + gap3.sd.area + D0 + H95 + 
#     Hsd + water.distance, family = binomial(), data = MBRA)
# 
# Coefficients:
#                Estimate Std. Error z value Pr(>|z|)    
# (Intercept)    -2.40805    0.04526 -53.209  < 2e-16 ***
# gap3.mean.area -0.30531    0.06786  -4.499 6.82e-06 ***
# gap3.sd.area   -0.09343    0.04414  -2.116   0.0343 *  
# D0             -0.32678    0.06311  -5.178 2.24e-07 ***
# H95             0.74136    0.11152   6.648 2.98e-11 ***
# Hsd            -0.23026    0.10086  -2.283   0.0224 *  
# water.distance -0.44066    0.04958  -8.888  < 2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# (Dispersion parameter for binomial family taken to be 1)
# 
#     Null deviance: 4651.0  on 7632  degrees of freedom
# Residual deviance: 4351.3  on 7626  degrees of freedom
# AIC: 4365.3
# 
# Number of Fisher Scoring iterations: 5



#----------------------------- gap3.mean
##getting predicted use 
range.gapmean <- range(MBRA$gap3.mean.area)
range.gapmean
# -0.7824953  1.5548690

mbra.plotting_dfm <- expand.grid(
  H95 = mean(MBRA$H95),
  D0 = mean(MBRA$D0),
  gap3.mean.area = seq(from = -0.7824953, to = 1.5548690, by = 0.3),
  gap3.sd.area = mean(MBRA$gap3.sd.area),
  Hsd = mean(MBRA$Hsd), 
  water.distance = mean(MBRA$water.distance)) 


mbra.plotting_dfm$preds <- plogis( predict(fit1mbra , newdata=mbra.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mbra.plotting_dfm, aes(x=gap3.mean.area, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by gap3.mean.area for Myots brandtii") + 
  ggplot2::ylab("Predicted Use")



#----------------------------- gap3.SD
##getting predicted use 
range.gapsd <- range(MBRA$gap3.sd.area)
range.gapsd
# -0.6537116  3.1228513

mbra.plotting_dfm <- expand.grid(
  H95 = mean(MBRA$H95),
  D0 = mean(MBRA$D0),
  gap3.mean.area = mean(MBRA$gap3.mean.area),
  gap3.sd.area = seq(from = -0.6537116, to = 3.1228513, by = 0.3),
  Hsd = mean(MBRA$Hsd), 
  water.distance = mean(MBRA$water.distance)) 


mbra.plotting_dfm$preds <- plogis( predict(fit1mbra , newdata=mbra.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mbra.plotting_dfm, aes(x=gap3.sd.area, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by gap3.sd.area for Myotis brandtii") + 
  ggplot2::ylab("Predicted Use")

#----------------------------- D0
##getting predicted use 
range.D0 <- range(MBRA$D0)
range.D0
# -1.059072  2.854221

mbra.plotting_dfm <- expand.grid(
  H95 = mean(MBRA$H95),
  D0 = seq(from = -1.059072  , to = 3.293983, by = 0.3),
  gap3.mean.area = mean(MBRA$gap3.mean.area),
  gap3.sd.area = mean(MBRA$gap3.sd.area),
  Hsd = mean(MBRA$Hsd), 
  water.distance = mean(MBRA$water.distance)) 


mbra.plotting_dfm$preds <- plogis( predict(fit1mbra , newdata=mbra.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mbra.plotting_dfm, aes(x=D0, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by D0 for Myotis brandtii") + 
  ggplot2::ylab("Predicted Use")

#----------------------------- Hsd
##getting predicted use 
range.Hsd <- range(MBRA$Hsd)
range.Hsd
# -2.125363  3.625778

mbra.plotting_dfm <- expand.grid(
  H95 = mean(MBRA$H95),
  D0 = mean(MBRA$D0),
  gap3.mean.area = mean(MBRA$gap3.mean.area),
  gap3.sd.area = mean(MBRA$gap3.sd.area),
  Hsd = seq(from = -2.125363  , to = 3.625778, by = 0.5), 
  water.distance = mean(MBRA$water.distance)) 


mbra.plotting_dfm$preds <- plogis( predict(fit1mbra , newdata=mbra.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mbra.plotting_dfm, aes(x=Hsd, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by Hsd for Myotis brandtii") + 
  ggplot2::ylab("Predicted Use")

#----------------------------- distance to water
##getting predicted use 
range.water.distance <- range(MBRA$water.distance)
range.water.distance
# -1.194830  3.878212

mbra.plotting_dfm <- expand.grid(
  H95 = mean(MBRA$H95),
  D0 = mean(MBRA$D0),
  gap3.mean.area = mean(MBRA$gap3.mean.area),
  gap3.sd.area = mean(MBRA$gap3.sd.area),
  Hsd = mean(MBRA$Hsd), 
  water.distance = seq(from = -1.194830  , to = 3.878212, by = 0.3)) 


mbra.plotting_dfm$preds <- plogis( predict(fit1mbra , newdata=mbra.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mbra.plotting_dfm, aes(x=water.distance, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by distance to water for Myotis brandtii") + 
  ggplot2::ylab("Predicted Use")



```






```{r}
######## MMYS ###########

############################################################

##refitting model with GLM to sketch results

fit1mmys<- glm(used ~ gap3.mean.area + gap3.sd.area +
                  D0 + H95 + Hsd + water.distance,
                  family=binomial(), data=MMYS)

summary(fit1mmys)
# Call:
# glm(formula = used ~ gap3.mean.area + gap3.sd.area + D0 + H95 + 
#     Hsd + water.distance, family = binomial(), data = MMYS)
# 
# Coefficients:
#                Estimate Std. Error z value Pr(>|z|)    
# (Intercept)    -2.56789    0.04748 -54.078  < 2e-16 ***
# gap3.mean.area  0.19242    0.06987   2.754 0.005889 ** 
# gap3.sd.area    0.13277    0.04628   2.869 0.004120 ** 
# D0              0.23425    0.06697   3.498 0.000469 ***
# H95             0.64274    0.11774   5.459 4.79e-08 ***
# Hsd             0.04368    0.09033   0.483 0.628755    
# water.distance -0.45563    0.05110  -8.916  < 2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# (Dispersion parameter for binomial family taken to be 1)
# 
#     Null deviance: 5408.0  on 8849  degrees of freedom
# Residual deviance: 5104.5  on 8843  degrees of freedom
# AIC: 5118.5
# 
# Number of Fisher Scoring iterations: 6


##getting predicted use as a function of zmax, at average zq60 and zcv
range.h95 <- range(MMYS$H95)
range.h95
# -2.174677  2.221490

mmys.plotting_dfm <- expand.grid(
  H95 = seq(from = -2.174677, to = 2.187593, by = 0.5),
  D0 = mean(MMYS$D0),
  gap3.sd.area = mean(MMYS$gap3.sd.area),
  gap3.mean.area = mean(MMYS$gap3.mean.area),
  Hsd = mean(MMYS$Hsd), 
  water.distance = mean(MMYS$water.distance)) 


mmys.plotting_dfm$preds <- plogis( predict(fit1mmys , newdata=mmys.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mmys.plotting_dfm, aes(x=H95, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by H95 for Myotis mystacinus") + 
  ggplot2::ylab("Predicted Use")


#----------------------------- gap3.mean
##getting predicted use 
range.gapmean <- range(MMYS$gap3.mean.area)
range.gapmean
# -0.782728  1.554869

mmys.plotting_dfm <- expand.grid(
  H95 = mean(MMYS$H95),
  D0 = mean(MMYS$D0),
  gap3.mean.area = seq(from = -0.782728, to = 1.554869, by = 0.3),
  gap3.sd.area = mean(MMYS$gap3.sd.area),
  Hsd = mean(MMYS$Hsd), 
  water.distance = mean(MMYS$water.distance)) 


mmys.plotting_dfm$preds <- plogis( predict(fit1mmys , newdata=mmys.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mmys.plotting_dfm, aes(x=gap3.mean.area, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by gap3.mean.area for Myots mystacinus") + 
  ggplot2::ylab("Predicted Use")


#----------------------------- gap3.SD
##getting predicted use 
range.gapsd <- range(MMYS$gap3.sd.area)
range.gapsd
# -0.6537116  3.1268099

mmys.plotting_dfm <- expand.grid(
  H95 = mean(MMYS$H95),
  D0 = mean(MMYS$D0),
  gap3.mean.area = mean(MMYS$gap3.mean.area),
  gap3.sd.area = seq(from = -0.6537116, to = 3.1268099, by = 0.3),
  Hsd = mean(MMYS$Hsd), 
  water.distance = mean(MMYS$water.distance)) 


mmys.plotting_dfm$preds <- plogis( predict(fit1mmys , newdata=mmys.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mmys.plotting_dfm, aes(x=gap3.sd.area, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by gap3.sd.area for Myotis mystacinus") + 
  ggplot2::ylab("Predicted Use")


#----------------------------- D0
##getting predicted use 
range.D0 <- range(MMYS$D0)
range.D0
# -1.059072  2.854221

mmys.plotting_dfm <- expand.grid(
  H95 = mean(MMYS$H95),
  D0 = seq(from = -1.059072, to = 2.854221, by = 0.3),
  gap3.mean.area = mean(MMYS$gap3.mean.area),
  gap3.sd.area = mean(MMYS$gap3.sd.area),
  Hsd = mean(MMYS$Hsd), 
  water.distance = mean(MMYS$water.distance)) 


mmys.plotting_dfm$preds <- plogis( predict(fit1mmys , newdata=mmys.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mmys.plotting_dfm, aes(x=D0, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by D0 for Myotis mystacinus") + 
  ggplot2::ylab("Predicted Use")

#----------------------------- Hsd
##getting predicted use 
range.Hsd <- range(MMYS$Hsd)
range.Hsd
# -2.118514  2.845969

mmys.plotting_dfm <- expand.grid(
  H95 = mean(MMYS$H95),
  D0 = mean(MMYS$D0),
  gap3.mean.area = mean(MMYS$gap3.mean.area),
  gap3.sd.area = mean(MMYS$gap3.sd.area),
  Hsd = seq(from = -2.118514  , to = 2.845969, by = 0.3), 
  water.distance = mean(MMYS$water.distance)) 


mmys.plotting_dfm$preds <- plogis( predict(fit1mmys , newdata=mmys.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mmys.plotting_dfm, aes(x=Hsd, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by Hsd for Myotis mystacinus") + 
  ggplot2::ylab("Predicted Use")


#----------------------------- distance to water
##getting predicted use 
range.water.distance <- range(MMYS$water.distance)
range.water.distance
# -1.194830  3.682869

mmys.plotting_dfm <- expand.grid(
  H95 = mean(MMYS$H95),
  D0 = mean(MMYS$D0),
  gap3.mean.area = mean(MMYS$gap3.mean.area),
  gap3.sd.area = mean(MMYS$gap3.sd.area),
  Hsd = mean(MMYS$Hsd), 
  water.distance = seq(from = -1.194830  , to = 3.682869, by = 0.3)) 


mmys.plotting_dfm$preds <- plogis( predict(fit1mmys , newdata=mmys.plotting_dfm))

 
##plotting the predicted response on the two covariates
windows()
pl <- ggplot(mmys.plotting_dfm, aes(x=water.distance, y =preds))
pl + 
  geom_point() +
  geom_smooth() + 
  ggtitle("Predicted Use by distance to water for Myotis mystacinus") + 
  ggplot2::ylab("Predicted Use")


```

